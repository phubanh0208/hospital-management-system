{% extends 'base.html' %}
{% load static %}
{% load date_filters %}

{% block title %}Profile - {{ hospital_name }}{% endblock %}

{% csrf_token %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card" style="box-shadow: var(--shadow-sm); border-radius: var(--radius-sm); background: var(--surface-card);">
                <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary)); color: #fff; border-top-left-radius: var(--radius-sm); border-top-right-radius: var(--radius-sm);">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>User Profile
                    </h5>
                    <a href="{% url 'authentication:profile_edit' %}" class="btn btn-light btn-sm">
                        <i class="fas fa-edit me-1"></i>Edit Profile
                    </a>
                </div>
                <div class="card-body">
                    <!-- Connection Status -->
                    <div class="alert {% if api_error %}alert-warning{% else %}alert-success{% endif %} mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas {% if api_error %}fa-exclamation-triangle{% else %}fa-check-circle{% endif %} me-2"></i>
                            <div>
                                <strong>API Connection:</strong>
                                {% if api_error %}
                                    <span class="text-warning">{{ api_error }}</span>
                                    <br><small>Showing cached session data</small>
                                {% else %}
                                    <span class="text-success">Connected - Live data from API</span>
                                    {% if not user_data.profile %}
                                        <br><small class="text-info">Profile information not yet completed</small>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Debug Info (Collapsible) -->
                    <div class="mb-3">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#debugInfo">
                            <i class="fas fa-bug me-1"></i>Debug Info
                        </button>
                        <div class="collapse mt-2" id="debugInfo">
                            <div class="card card-body bg-light">
                                <small>
                                    <strong>Session Data:</strong><br>
                                    Username: {{ session_data.username }}<br>
                                    Role: {{ session_data.user_role }}<br>
                                    Email: {{ session_data.user_email }}<br>
                                    Token: {{ token_preview }}<br>
                                    <strong>API Data:</strong> {{ user_data|yesno:"Available,Not Available" }}<br>
                                    {% if user_data %}
                                    API Keys: {{ user_data.keys|join:", " }}
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>

                    {% if user_data or session_data.username %}

                    <!-- Profile Header with Avatar -->
                    <div class="row mb-4">
                        <div class="col-12 text-center">
                            {% if user_data.profile and user_data.profile.avatarUrl %}
                                <img src="{{ user_data.profile.avatarUrl }}"
                                     alt="User Avatar"
                                     class="rounded-circle border border-3 border-primary mb-3"
                                     style="width: 120px; height: 120px; object-fit: cover;"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="avatar-placeholder rounded-circle border border-3 border-primary mx-auto mb-3"
                                     style="width: 120px; height: 120px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: none; align-items: center; justify-content: center; color: white; font-size: 48px; font-weight: bold;">
                                    {% if user_data.profile.firstName and user_data.profile.lastName %}
                                        {{ user_data.profile.firstName|first }}{{ user_data.profile.lastName|first }}
                                    {% else %}
                                        {{ user_data.username|first|upper }}
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="avatar-placeholder rounded-circle border border-3 border-primary mx-auto mb-3"
                                     style="width: 120px; height: 120px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px; font-weight: bold;">
                                    {% if user_data.profile.firstName and user_data.profile.lastName %}
                                        {{ user_data.profile.firstName|first }}{{ user_data.profile.lastName|first }}
                                    {% else %}
                                        {{ user_data.username|first|upper }}
                                    {% endif %}
                                </div>
                            {% endif %}

                            <h4 class="mb-1">
                                {% if user_data.profile.firstName and user_data.profile.lastName %}
                                    {{ user_data.profile.firstName }} {{ user_data.profile.lastName }}
                                {% else %}
                                    {{ user_data.username|default:session_data.username }}
                                {% endif %}
                            </h4>
                            <p class="text-muted mb-0">
                                <i class="fas fa-user-tag me-1"></i>
                                {{ user_data.role|default:session_data.user_role|title }}
                            </p>
                            {% if user_data.email %}
                                <p class="text-muted">
                                    <i class="fas fa-envelope me-1"></i>
                                    {{ user_data.email }}
                                </p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row"

                        <div class="col-md-6">
                            <h6>Personal Information</h6>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Username:</strong></td>
                                    <td>{{ user_data.username|default:session_data.username }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Email:</strong></td>
                                    <td>{{ user_data.email|default:session_data.user_email }}</td>
                                </tr>
                                <tr>
                                    <td><strong>First Name:</strong></td>
                                    <td>
                                        {% if user_data.profile %}
                                            {{ user_data.profile.firstName|default:"Not provided" }}
                                        {% else %}
                                            Not provided
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Last Name:</strong></td>
                                    <td>
                                        {% if user_data.profile %}
                                            {{ user_data.profile.lastName|default:"Not provided" }}
                                        {% else %}
                                            Not provided
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Phone:</strong></td>
                                    <td>
                                        {% if user_data.profile %}
                                            {{ user_data.profile.phone|default:"Not provided" }}
                                        {% else %}
                                            Not provided
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Date of Birth:</strong></td>
                                    <td>
                                        {% if user_data.profile %}
                                            {{ user_data.profile.dateOfBirth|format_date_of_birth }}
                                        {% else %}
                                            Not provided
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Address:</strong></td>
                                    <td>
                                        {% if user_data.profile %}
                                            {{ user_data.profile.address|linebreaks|default:"Not provided" }}
                                        {% else %}
                                            Not provided
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Avatar:</strong></td>
                                    <td>
                                        {% if user_data.profile and user_data.profile.avatarUrl %}
                                            <img src="{{ user_data.profile.avatarUrl }}"
                                                 alt="Avatar"
                                                 class="rounded border"
                                                 style="width: 50px; height: 50px; object-fit: cover;">
                                            <small class="ms-2 text-muted">{{ user_data.profile.avatarUrl }}</small>
                                        {% else %}
                                            Not provided
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Role:</strong></td>
                                    <td><span class="badge bg-primary">{{ user_data.role|default:session_data.user_role|title }}</span></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Doctor Profile Section (only for doctors) -->
                        {% if user_data.role == 'doctor' or session_data.user_role == 'doctor' %}
                        <div class="col-12 mt-4">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="fas fa-user-md me-2"></i>Doctor Profile
                                    </h6>
                                    <button class="btn btn-light btn-sm" onclick="editDoctorProfile()">
                                        <i class="fas fa-edit me-1"></i>Edit Profile
                                    </button>
                                </div>
                                <div class="card-body" id="doctorProfileSection">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading doctor profile...</span>
                                        </div>
                                        <p class="mt-2">Loading doctor profile...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="col-md-6">
                            <h6>Account Information</h6>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>User ID:</strong></td>
                                    <td><code>{{ user_data.id|default:session_data.user_id|default:"Not available" }}</code></td>
                                </tr>
                                <tr>
                                    <td><strong>Created:</strong></td>
                                    <td>{{ user_data.createdAt|parse_iso_date }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Last Updated:</strong></td>
                                    <td>{{ user_data.updatedAt|parse_iso_date }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td>
                                        {% if user_data.isActive %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-warning">Status Unknown</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <div class="mt-4">
                        <a href="{% url 'authentication:change_password' %}" class="btn btn-primary">
                            <i class="fas fa-key me-2"></i>Change Password
                        </a>
                        <a href="{% url 'dashboard:index' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                        </a>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <h6>Unable to load profile information</h6>
                        <p>This could be due to:</p>
                        <ul>
                            <li>API connection issues</li>
                            <li>Authentication token expired</li>
                            <li>Server communication problems</li>
                        </ul>
                        <a href="{% url 'authentication:login' %}" class="btn btn-warning">
                            <i class="fas fa-sign-in-alt me-2"></i>Login Again
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Doctor Profile Management
let doctorProfileData = null;

// Load doctor profile on page load
document.addEventListener('DOMContentLoaded', function() {
    {% if user_data.role == 'doctor' or session_data.user_role == 'doctor' %}
    loadDoctorProfile();
    {% endif %}
});

function loadDoctorProfile() {
    const userId = '{{ user_data.id|default:session_data.user_id }}';

    fetch('/auth/api/doctors/my/profile/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                doctorProfileData = data.data;
                displayDoctorProfile(doctorProfileData);
            } else {
                displayDoctorProfileError('Doctor profile not found. Click "Edit Profile" to create one.');
            }
        })
        .catch(error => {
            console.error('Error loading doctor profile:', error);
            displayDoctorProfileError('Error loading doctor profile. Please try again.');
        });
}

function displayDoctorProfile(profile) {
    const section = document.getElementById('doctorProfileSection');

    const html = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-primary">Professional Information</h6>
                <table class="table table-sm table-borderless">
                    <tr>
                        <td><strong>Specialization:</strong></td>
                        <td>${profile.specialization || 'Not specified'}</td>
                    </tr>
                    <tr>
                        <td><strong>License Number:</strong></td>
                        <td>${profile.licenseNumber || 'Not provided'}</td>
                    </tr>
                    <tr>
                        <td><strong>Years of Experience:</strong></td>
                        <td>${profile.yearsOfExperience || 0} years</td>
                    </tr>
                    <tr>
                        <td><strong>Consultation Fee:</strong></td>
                        <td>$${profile.consultationFee || 'Contact for pricing'}</td>
                    </tr>
                    <tr>
                        <td><strong>Status:</strong></td>
                        <td>
                            <span class="badge ${profile.isAcceptingPatients ? 'bg-success' : 'bg-secondary'}">
                                ${profile.isAcceptingPatients ? 'Accepting Patients' : 'Not Accepting'}
                            </span>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="text-primary">Education & Languages</h6>
                <div class="mb-3">
                    <strong>Education:</strong>
                    <p class="mb-2 small">${profile.education || 'Not provided'}</p>
                </div>
                <div class="mb-3">
                    <strong>Certifications:</strong>
                    <div class="mt-1">
                        ${profile.certifications && profile.certifications.length > 0
                            ? profile.certifications.map(cert => `<span class="badge bg-info me-1 mb-1">${cert}</span>`).join('')
                            : '<span class="text-muted">None specified</span>'
                        }
                    </div>
                </div>
                <div>
                    <strong>Languages:</strong>
                    <div class="mt-1">
                        ${profile.languagesSpoken && profile.languagesSpoken.length > 0
                            ? profile.languagesSpoken.map(lang => `<span class="badge bg-secondary me-1 mb-1">${lang}</span>`).join('')
                            : '<span class="text-muted">None specified</span>'
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-12">
                <h6 class="text-primary">Availability Schedule</h6>
                <div id="availabilitySchedule">
                    ${displayAvailabilityHours(profile.availabilityHours)}
                </div>
            </div>
        </div>
    `;

    section.innerHTML = html;
}

function displayAvailabilityHours(availabilityHours) {
    if (!availabilityHours || Object.keys(availabilityHours).length === 0) {
        return '<p class="text-muted">No availability schedule set</p>';
    }

    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

    let html = '<div class="row">';

    days.forEach((day, index) => {
        const schedule = availabilityHours[day];
        html += `
            <div class="col-md-6 col-lg-4 mb-2">
                <div class="card card-body py-2 ${schedule ? 'border-success' : 'border-light'}">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong class="small">${dayNames[index]}</strong>
                        ${schedule
                            ? `<span class="badge bg-success small">${schedule.start} - ${schedule.end}</span>`
                            : '<span class="badge bg-secondary small">Closed</span>'
                        }
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    return html;
}

function displayDoctorProfileError(message) {
    const section = document.getElementById('doctorProfileSection');
    section.innerHTML = `
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

function editDoctorProfile() {
    // Open doctor profile edit modal
    showDoctorProfileModal();
}

function showDoctorProfileModal() {
    // Create modal HTML
    const modalHtml = `
        <div class="modal fade" id="doctorProfileModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-user-md me-2"></i>Edit Doctor Profile
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="doctorProfileForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Specialization *</label>
                                        <select class="form-select" name="specialization" required>
                                            <option value="">Select specialization</option>
                                            <option value="Cardiology">Cardiology</option>
                                            <option value="Neurology">Neurology</option>
                                            <option value="Orthopedics">Orthopedics</option>
                                            <option value="Pediatrics">Pediatrics</option>
                                            <option value="General Medicine">General Medicine</option>
                                            <option value="Dermatology">Dermatology</option>
                                            <option value="Psychiatry">Psychiatry</option>
                                            <option value="Surgery">Surgery</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">License Number *</label>
                                        <input type="text" class="form-control" name="licenseNumber" required>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Years of Experience</label>
                                        <input type="number" class="form-control" name="yearsOfExperience" min="0" max="50">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Consultation Fee ($)</label>
                                        <input type="number" class="form-control" name="consultationFee" min="0" step="0.01">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Education</label>
                                <textarea class="form-control" name="education" rows="3"
                                    placeholder="e.g., MD from Harvard Medical School, Fellowship in Cardiology"></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Certifications (one per line)</label>
                                <textarea class="form-control" name="certifications" rows="3"
                                    placeholder="e.g., Board Certified Cardiologist&#10;Advanced Cardiac Life Support"></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Languages Spoken (comma separated)</label>
                                <input type="text" class="form-control" name="languagesSpoken"
                                    placeholder="e.g., English, Vietnamese, French">
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="isAcceptingPatients" id="isAcceptingPatients">
                                    <label class="form-check-label" for="isAcceptingPatients">
                                        Currently accepting new patients
                                    </label>
                                </div>
                            </div>

                            <!-- Availability Schedule -->
                            <div class="mb-3">
                                <label class="form-label">Weekly Availability Schedule</label>
                                <div class="availability-schedule">
                                    <div class="row mb-2">
                                        <div class="col-3"><strong>Day</strong></div>
                                        <div class="col-3"><strong>Available</strong></div>
                                        <div class="col-3"><strong>Start Time</strong></div>
                                        <div class="col-3"><strong>End Time</strong></div>
                                    </div>

                                    <div class="row mb-2" data-day="monday">
                                        <div class="col-3">
                                            <label class="form-label small">Monday</label>
                                        </div>
                                        <div class="col-3">
                                            <div class="form-check">
                                                <input class="form-check-input day-checkbox" type="checkbox" name="monday_available" id="monday_available">
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <input type="time" class="form-control form-control-sm" name="monday_start" disabled>
                                        </div>
                                        <div class="col-3">
                                            <input type="time" class="form-control form-control-sm" name="monday_end" disabled>
                                        </div>
                                    </div>

                                    <div class="row mb-2" data-day="tuesday">
                                        <div class="col-3">
                                            <label class="form-label small">Tuesday</label>
                                        </div>
                                        <div class="col-3">
                                            <div class="form-check">
                                                <input class="form-check-input day-checkbox" type="checkbox" name="tuesday_available" id="tuesday_available">
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <input type="time" class="form-control form-control-sm" name="tuesday_start" disabled>
                                        </div>
                                        <div class="col-3">
                                            <input type="time" class="form-control form-control-sm" name="tuesday_end" disabled>
                                        </div>
                                    </div>

                                    <div class="row mb-2" data-day="wednesday">
                                        <div class="col-3">
                                            <label class="form-label small">Wednesday</label>
                                        </div>
                                        <div class="col-3">
                                            <div class="form-check">
                                                <input class="form-check-input day-checkbox" type="checkbox" name="wednesday_available" id="wednesday_available">
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <input type="time" class="form-control form-control-sm" name="wednesday_start" disabled>
                                        </div>
                                        <div class="col-3">
                                            <input type="time" class="form-control form-control-sm" name="wednesday_end" disabled>
                                        </div>
                                    </div>

                                    <div class="row mb-2" data-day="thursday">
                                        <div class="col-3">
                                            <label class="form-label small">Thursday</label>
                                        </div>
                                        <div class="col-3">
                                            <div class="form-check">
                                                <input class="form-check-input day-checkbox" type="checkbox" name="thursday_available" id="thursday_available">
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <input type="time" class="form-control form-control-sm" name="thursday_start" disabled>
                                        </div>
                                        <div class="col-3">
                                            <input type="time" class="form-control form-control-sm" name="thursday_end" disabled>
                                        </div>
                                    </div>

                                    <div class="row mb-2" data-day="friday">
                                        <div class="col-3">
                                            <label class="form-label small">Friday</label>
                                        </div>
                                        <div class="col-3">
                                            <div class="form-check">
                                                <input class="form-check-input day-checkbox" type="checkbox" name="friday_available" id="friday_available">
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <input type="time" class="form-control form-control-sm" name="friday_start" disabled>
                                        </div>
                                        <div class="col-3">
                                            <input type="time" class="form-control form-control-sm" name="friday_end" disabled>
                                        </div>
                                    </div>

                                    <div class="row mb-2" data-day="saturday">
                                        <div class="col-3">
                                            <label class="form-label small">Saturday</label>
                                        </div>
                                        <div class="col-3">
                                            <div class="form-check">
                                                <input class="form-check-input day-checkbox" type="checkbox" name="saturday_available" id="saturday_available">
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <input type="time" class="form-control form-control-sm" name="saturday_start" disabled>
                                        </div>
                                        <div class="col-3">
                                            <input type="time" class="form-control form-control-sm" name="saturday_end" disabled>
                                        </div>
                                    </div>

                                    <div class="row mb-2" data-day="sunday">
                                        <div class="col-3">
                                            <label class="form-label small">Sunday</label>
                                        </div>
                                        <div class="col-3">
                                            <div class="form-check">
                                                <input class="form-check-input day-checkbox" type="checkbox" name="sunday_available" id="sunday_available">
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <input type="time" class="form-control form-control-sm" name="sunday_start" disabled>
                                        </div>
                                        <div class="col-3">
                                            <input type="time" class="form-control form-control-sm" name="sunday_end" disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveDoctorProfile()">
                            <i class="fas fa-save me-1"></i>Save Profile
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal if any
    const existingModal = document.getElementById('doctorProfileModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Populate form if we have existing data
    if (doctorProfileData) {
        populateDoctorProfileForm(doctorProfileData);
    }

    // Setup availability schedule handlers
    setupAvailabilitySchedule();

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('doctorProfileModal'));
    modal.show();
}

function populateDoctorProfileForm(profile) {
    const form = document.getElementById('doctorProfileForm');

    // Set form values
    form.specialization.value = profile.specialization || '';
    form.licenseNumber.value = profile.licenseNumber || '';
    form.yearsOfExperience.value = profile.yearsOfExperience || '';
    form.consultationFee.value = profile.consultationFee || '';
    form.education.value = profile.education || '';
    form.isAcceptingPatients.checked = profile.isAcceptingPatients || false;

    // Handle certifications array
    if (profile.certifications && profile.certifications.length > 0) {
        form.certifications.value = profile.certifications.join('\n');
    }

    // Handle languages array
    if (profile.languagesSpoken && profile.languagesSpoken.length > 0) {
        form.languagesSpoken.value = profile.languagesSpoken.join(', ');
    }

    // Handle availability schedule
    if (profile.availabilityHours) {
        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        days.forEach(day => {
            const schedule = profile.availabilityHours[day];
            const checkbox = form.querySelector(`[name="${day}_available"]`);
            const startTime = form.querySelector(`[name="${day}_start"]`);
            const endTime = form.querySelector(`[name="${day}_end"]`);

            if (schedule && schedule.start && schedule.end) {
                checkbox.checked = true;
                startTime.disabled = false;
                endTime.disabled = false;
                startTime.value = schedule.start;
                endTime.value = schedule.end;
            } else {
                checkbox.checked = false;
                startTime.disabled = true;
                endTime.disabled = true;
                startTime.value = '';
                endTime.value = '';
            }
        });
    }
}

function setupAvailabilitySchedule() {
    // Handle day checkbox changes
    const dayCheckboxes = document.querySelectorAll('.day-checkbox');
    dayCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const dayName = this.name.replace('_available', '');
            const startTime = document.querySelector(`[name="${dayName}_start"]`);
            const endTime = document.querySelector(`[name="${dayName}_end"]`);

            if (this.checked) {
                startTime.disabled = false;
                endTime.disabled = false;
                // Set default times if empty
                if (!startTime.value) startTime.value = '09:00';
                if (!endTime.value) endTime.value = '17:00';
            } else {
                startTime.disabled = true;
                endTime.disabled = true;
                startTime.value = '';
                endTime.value = '';
            }
        });
    });
}

function saveDoctorProfile() {
    const form = document.getElementById('doctorProfileForm');
    const formData = new FormData(form);

    // Convert form data to JSON
    const profileData = {
        specialization: formData.get('specialization'),
        licenseNumber: formData.get('licenseNumber'),
        yearsOfExperience: parseInt(formData.get('yearsOfExperience')) || 0,
        consultationFee: parseFloat(formData.get('consultationFee')) || 0,
        education: formData.get('education'),
        certifications: formData.get('certifications')
            ? formData.get('certifications').split('\n').filter(cert => cert.trim())
            : [],
        languagesSpoken: formData.get('languagesSpoken')
            ? formData.get('languagesSpoken').split(',').map(lang => lang.trim()).filter(lang => lang)
            : [],
        isAcceptingPatients: formData.has('isAcceptingPatients'),
        availabilityHours: {}
    };

    // Process availability schedule
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    days.forEach(day => {
        const isAvailable = formData.has(`${day}_available`);
        if (isAvailable) {
            const startTime = formData.get(`${day}_start`);
            const endTime = formData.get(`${day}_end`);
            if (startTime && endTime) {
                profileData.availabilityHours[day] = {
                    start: startTime,
                    end: endTime
                };
            }
        }
    });

    // Validate required fields
    if (!profileData.specialization || !profileData.licenseNumber) {
        alert('Please fill in all required fields (Specialization and License Number)');
        return;
    }

    const userId = '{{ user_data.id|default:session_data.user_id }}';
    const url = doctorProfileData
        ? '/auth/api/doctors/my/profile/'
        : '/auth/api/doctors/my/profile/';
    const method = doctorProfileData ? 'PUT' : 'POST';

    // Add userId for new profiles
    if (!doctorProfileData) {
        profileData.userId = userId;
    }

    // Show loading
    const saveBtn = document.querySelector('#doctorProfileModal .btn-primary');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
    saveBtn.disabled = true;

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: JSON.stringify(profileData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('doctorProfileModal'));
            modal.hide();

            // Reload profile
            loadDoctorProfile();

            // Show success message
            showAlert('Doctor profile saved successfully!', 'success');
        } else {
            throw new Error(data.message || 'Failed to save profile');
        }
    })
    .catch(error => {
        console.error('Error saving doctor profile:', error);
        showAlert('Error saving doctor profile: ' + error.message, 'danger');
    })
    .finally(() => {
        // Reset button
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

    const container = document.querySelector('.container-fluid');
    container.insertAdjacentHTML('afterbegin', alertHtml);

    // Auto dismiss after 5 seconds
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 5000);
}
</script>
{% endblock %}
