{% extends 'base.html' %}
{% load static %}

{% block title %}User Details - {{ hospital_name }}{% endblock %}

{% block extra_css %}
<style>
.user-avatar {
    width: 120px;
    height: 120px;
    background: linear-gradient(135deg, var(--bs-primary), var(--bs-info));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 3rem;
    font-weight: 300;
    margin: 0 auto 1rem;
    border: 4px solid white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.info-card {
    border: none;
    border-radius: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
}
.info-card .card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 1rem 1.5rem;
}
.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f1f3f4;
}
.info-item:last-child {
    border-bottom: none;
}
.info-label {
    font-weight: 600;
    color: #495057;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.info-value {
    color: #6c757d;
    text-align: right;
}
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
}
.status-active { background-color: #28a745; }
.status-inactive { background-color: #dc3545; }
.role-badge {
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 0.4rem 0.8rem;
    border-radius: 1rem;
}
.edit-section {
    background: #f8f9fa;
    border-radius: 1rem;
    padding: 1.5rem;
    margin-top: 1rem;
}
.btn-action {
    border-radius: 0.5rem;
    padding: 0.5rem 1rem;
    font-weight: 500;
    transition: all 0.3s ease;
}
.btn-action:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
.activity-item {
    padding: 1rem;
    border-left: 3px solid var(--bs-primary);
    background: #f8f9fa;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
}
.activity-time {
    font-size: 0.875rem;
    color: #6c757d;
}
</style>
{% endblock %}

{% block content %}
<!-- Hidden CSRF token for AJAX requests -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="{% url 'dashboard:index' %}">Dashboard</a>
                            </li>
                            <li class="breadcrumb-item">
                                <a href="{% url 'users:list' %}">Users</a>
                            </li>
                            <li class="breadcrumb-item active">{{ user.username }}</li>
                        </ol>
                    </nav>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-user text-primary me-2"></i>
                        User Details
                    </h1>
                    <p class="text-muted mb-0">View and manage user information</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'users:list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Users
                    </a>
                    <button type="button" class="btn btn-primary" onclick="toggleEditMode()">
                        <i class="fas fa-edit me-1"></i>Edit User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- User Profile Card -->
        <div class="col-lg-4">
            <div class="info-card">
                <div class="card-header text-center">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <h4 class="mb-1">{{ user.username }}</h4>
                    <p class="mb-0 opacity-75">
                        {% if user.profile.firstName or user.profile.lastName %}
                            {{ user.profile.firstName }} {{ user.profile.lastName }}
                        {% else %}
                            No name provided
                        {% endif %}
                    </p>
                </div>
                <div class="card-body">
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-shield-alt"></i>
                            Role
                        </div>
                        <div class="info-value">
                            <span class="badge role-badge 
                                {% if user.role == 'admin' %}bg-danger
                                {% elif user.role == 'doctor' %}bg-success
                                {% elif user.role == 'nurse' %}bg-info
                                {% elif user.role == 'staff' %}bg-warning text-dark
                                {% else %}bg-secondary{% endif %}">
                                {{ user.role|capfirst }}
                            </span>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-circle"></i>
                            Status
                        </div>
                        <div class="info-value">
                            <span class="status-indicator {% if user.isActive %}status-active{% else %}status-inactive{% endif %}"></span>
                            {% if user.isActive %}Active{% else %}Inactive{% endif %}
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-calendar-plus"></i>
                            Created
                        </div>
                        <div class="info-value">
                            {{ user.createdAt|date:"M d, Y" }}
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-calendar-check"></i>
                            Updated
                        </div>
                        <div class="info-value">
                            {{ user.updatedAt|date:"M d, Y" }}
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-white border-0 pt-0">
                    <div class="d-grid gap-2">
                        {% if user.isActive %}
                            <button class="btn btn-outline-warning btn-action" 
                                    onclick="toggleUserStatus('{{ user.id }}', 'deactivate')">
                                <i class="fas fa-times-circle me-2"></i>Deactivate User
                            </button>
                        {% else %}
                            <button class="btn btn-outline-success btn-action" 
                                    onclick="toggleUserStatus('{{ user.id }}', 'activate')">
                                <i class="fas fa-check-circle me-2"></i>Activate User
                            </button>
                        {% endif %}
                        <button class="btn btn-outline-danger btn-action" 
                                onclick="deleteUser('{{ user.id }}', '{{ user.username }}')">
                            <i class="fas fa-trash me-2"></i>Delete User
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Details and Edit Form -->
        <div class="col-lg-8">
            <!-- View Mode -->
            <div id="viewMode">
                <div class="info-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Account Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-user"></i>
                                Username
                            </div>
                            <div class="info-value">{{ user.username }}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-envelope"></i>
                                Email
                            </div>
                            <div class="info-value">{{ user.email|default:"Not provided" }}</div>
                        </div>
                    </div>
                </div>

                {% if user.profile %}
                <div class="info-card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-address-card me-2"></i>
                            Profile Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-user-tag"></i>
                                Full Name
                            </div>
                            <div class="info-value">
                                {% if user.profile.firstName or user.profile.lastName %}
                                    {{ user.profile.firstName }} {{ user.profile.lastName }}
                                {% else %}
                                    Not provided
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-phone"></i>
                                Phone
                            </div>
                            <div class="info-value">{{ user.profile.phone|default:"Not provided" }}</div>
                        </div>
                        
                        <div class="info-item">
                            <div class="info-label">
                                <i class="fas fa-map-marker-alt"></i>
                                Address
                            </div>
                            <div class="info-value">{{ user.profile.address|default:"Not provided" }}</div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Edit Mode -->
            <div id="editMode" style="display: none;">
                <form method="POST" id="editUserForm" novalidate>
                    {% csrf_token %}
                    
                    <div class="info-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-edit me-2"></i>
                                Edit Account Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" 
                                               class="form-control" 
                                               id="edit_username" 
                                               name="username" 
                                               value="{{ user.username }}"
                                               required
                                               maxlength="50"
                                               pattern="[a-zA-Z0-9_.-]+"
                                               title="Username can only contain letters, numbers, dots, underscores and hyphens">
                                        <label for="edit_username">Username *</label>
                                        <div class="invalid-feedback">
                                            Please provide a valid username.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="email" 
                                               class="form-control" 
                                               id="edit_email" 
                                               name="email" 
                                               value="{{ user.email }}"
                                               required>
                                        <label for="edit_email">Email *</label>
                                        <div class="invalid-feedback">
                                            Please provide a valid email address.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select class="form-select" id="edit_role" name="role" required>
                                            <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Administrator</option>
                                            <option value="doctor" {% if user.role == 'doctor' %}selected{% endif %}>Doctor</option>
                                            <option value="nurse" {% if user.role == 'nurse' %}selected{% endif %}>Nurse</option>
                                            <option value="staff" {% if user.role == 'staff' %}selected{% endif %}>Staff</option>
                                            <option value="patient" {% if user.role == 'patient' %}selected{% endif %}>Patient</option>
                                        </select>
                                        <label for="edit_role">Role *</label>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-check form-switch mt-3">
                                        <input type="checkbox" 
                                               class="form-check-input" 
                                               id="edit_is_active" 
                                               name="is_active"
                                               {% if user.isActive %}checked{% endif %}>
                                        <label class="form-check-label" for="edit_is_active">
                                            Active User
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="info-card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-address-card me-2"></i>
                                Edit Profile Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" 
                                               class="form-control" 
                                               id="edit_first_name" 
                                               name="first_name" 
                                               value="{% if user.profile %}{{ user.profile.firstName }}{% endif %}"
                                               maxlength="50">
                                        <label for="edit_first_name">First Name</label>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" 
                                               class="form-control" 
                                               id="edit_last_name" 
                                               name="last_name" 
                                               value="{% if user.profile %}{{ user.profile.lastName }}{% endif %}"
                                               maxlength="50">
                                        <label for="edit_last_name">Last Name</label>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="tel" 
                                               class="form-control" 
                                               id="edit_phone" 
                                               name="phone" 
                                               value="{% if user.profile %}{{ user.profile.phone }}{% endif %}"
                                               pattern="[\+]?[0-9\s\-\(\)]+"
                                               title="Please enter a valid phone number">
                                        <label for="edit_phone">Phone Number</label>
                                        <div class="invalid-feedback">
                                            Please enter a valid phone number.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <textarea class="form-control" 
                                                  id="edit_address" 
                                                  name="address" 
                                                  style="height: 58px;"
                                                  maxlength="200">{% if user.profile %}{{ user.profile.address }}{% endif %}</textarea>
                                        <label for="edit_address">Address</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-footer bg-white border-0">
                            <div class="d-flex gap-2 justify-content-end">
                                <button type="button" 
                                        class="btn btn-outline-secondary"
                                        onclick="toggleEditMode()">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </button>
                                <button type="submit" 
                                        class="btn btn-primary"
                                        id="saveButton">
                                    <i class="fas fa-save me-1"></i>Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                    Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the user <strong id="deleteUserName"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-warning me-2"></i>
                    This action cannot be undone. All user data will be permanently deleted.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    <i class="fas fa-trash me-2"></i>Delete User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Status Toggle Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="statusModalMessage"></p>
                <div class="mb-3">
                    <label for="statusReason" class="form-label">Reason (Optional)</label>
                    <textarea class="form-control" id="statusReason" rows="3" placeholder="Enter reason for status change..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmStatus"></button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Toggle between view and edit modes
function toggleEditMode() {
    const viewMode = document.getElementById('viewMode');
    const editMode = document.getElementById('editMode');
    
    if (viewMode.style.display === 'none') {
        // Switch to view mode
        viewMode.style.display = 'block';
        editMode.style.display = 'none';
    } else {
        // Switch to edit mode
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
    }
}

// Form validation
function validateEditForm() {
    let isValid = true;
    const form = document.getElementById('editUserForm');
    
    // Get all required fields
    const requiredFields = form.querySelectorAll('[required]');
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            field.classList.remove('is-valid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
        }
    });
    
    // Custom email validation
    const email = document.getElementById('edit_email');
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (email.value && !emailRegex.test(email.value)) {
        email.classList.add('is-invalid');
        email.classList.remove('is-valid');
        isValid = false;
    }
    
    // Custom username validation
    const username = document.getElementById('edit_username');
    const usernameRegex = /^[a-zA-Z0-9_.-]+$/;
    if (username.value && !usernameRegex.test(username.value)) {
        username.classList.add('is-invalid');
        username.classList.remove('is-valid');
        isValid = false;
    }
    
    // Custom phone validation (if provided)
    const phone = document.getElementById('edit_phone');
    const phoneRegex = /^[\+]?[0-9\s\-\(\)]+$/;
    if (phone.value && !phoneRegex.test(phone.value)) {
        phone.classList.add('is-invalid');
        phone.classList.remove('is-valid');
        isValid = false;
    }
    
    return isValid;
}

// Delete user function
function deleteUser(userId, username) {
    document.getElementById('deleteUserName').textContent = username;
    
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
    
    document.getElementById('confirmDelete').onclick = function() {
        performDelete(userId);
    };
}

function performDelete(userId) {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]')?.value || '');
    
    fetch(`/users/${userId}/delete/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            deleteModal.hide();
            
            // Show success message and redirect
            showAlert('success', data.message);
            setTimeout(() => {
                window.location.href = data.redirect;
            }, 1500);
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        showAlert('danger', 'An error occurred while deleting the user.');
    });
}

// Toggle user status
function toggleUserStatus(userId, action) {
    const isActivating = action === 'activate';
    const title = isActivating ? 'Activate User' : 'Deactivate User';
    const message = isActivating ? 
        'Are you sure you want to activate this user?' : 
        'Are you sure you want to deactivate this user?';
    const buttonText = isActivating ? 'Activate' : 'Deactivate';
    const buttonClass = isActivating ? 'btn-success' : 'btn-warning';
    
    document.getElementById('statusModalTitle').innerHTML = 
        `<i class="fas fa-${isActivating ? 'check' : 'times'}-circle me-2"></i>${title}`;
    document.getElementById('statusModalMessage').textContent = message;
    
    const confirmButton = document.getElementById('confirmStatus');
    confirmButton.innerHTML = `<i class="fas fa-${isActivating ? 'check' : 'times'}-circle me-2"></i>${buttonText}`;
    confirmButton.className = `btn ${buttonClass}`;
    
    const statusModal = new bootstrap.Modal(document.getElementById('statusModal'));
    statusModal.show();
    
    confirmButton.onclick = function() {
        performStatusToggle(userId, action);
    };
}

function performStatusToggle(userId, action) {
    const reason = document.getElementById('statusReason').value.trim();
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]')?.value || '');
    formData.append('action', action);
    formData.append('reason', reason);
    
    fetch(`/users/${userId}/status/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const statusModal = bootstrap.Modal.getInstance(document.getElementById('statusModal'));
            statusModal.hide();
            
            // Clear reason field
            document.getElementById('statusReason').value = '';
            
            // Show success message and reload
            showAlert('success', data.message);
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        console.error('Status toggle error:', error);
        showAlert('danger', 'An error occurred while changing user status.');
    });
}

// Show alert function
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Form submission
    const editForm = document.getElementById('editUserForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (validateEditForm()) {
                const saveButton = document.getElementById('saveButton');
                const originalText = saveButton.innerHTML;
                
                // Show loading state
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
                saveButton.disabled = true;
                
                // Submit form
                this.submit();
            } else {
                showAlert('warning', 'Please correct the errors in the form before submitting.');
            }
        });
    }
    
    // Real-time validation
    document.querySelectorAll('#editMode input, #editMode select').forEach(field => {
        field.addEventListener('blur', function() {
            if (this.hasAttribute('required') && !this.value.trim()) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
            } else if (this.value.trim()) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });
    });
});
</script>
{% endblock %}
