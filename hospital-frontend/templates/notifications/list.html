{% extends 'base.html' %}
{% load static %}

{% block title %}Notifications - {{ hospital_name }}{% endblock %}

{% block extra_css %}
<style>
    .notification-card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        border: 1px solid #e3e8ee;
        transition: all 0.3s ease;
        margin-bottom: 1rem;
    }
    
    .notification-card:hover {
        box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }
    
    .notification-header {
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 10px 10px 0 0;
        margin: -1px -1px 0 -1px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .admin-badge {
        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .retry-status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .status-pending {
        background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
        color: #8B4513;
    }
    
    .status-processing {
        background: linear-gradient(135deg, #74b9ff, #0984e3);
        color: white;
    }
    
    .status-failed {
        background: linear-gradient(135deg, #ff7675, #d63031);
        color: white;
    }
    
    .status-success {
        background: linear-gradient(135deg, #00b894, #00a085);
        color: white;
    }
    
    .quick-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .btn-quick {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
        border-radius: 20px;
        border: none;
        transition: all 0.3s ease;
    }
    
    .btn-quick:hover {
        transform: translateY(-1px);
    }
    
    .stats-overview {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }
    
    .stat-label {
        font-size: 0.85rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Notification Item Styles */
    .notification-item {
        background: #fff;
        border: 1px solid #e3e8ee;
        border-radius: 10px;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .notification-item:hover {
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .notification-item.unread {
        border-left: 4px solid #007bff;
        background: rgba(0, 123, 255, 0.02);
    }
    
    .notification-content {
        padding: 1.5rem;
    }
    
    .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        background: none;
        padding: 0;
        border-radius: 0;
        color: inherit;
    }
    
    .notification-type {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .type-badge {
        background: #f8f9fa;
        color: #495057;
        padding: 0.25rem 0.5rem;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 500;
        border: 1px solid #dee2e6;
    }
    
    .type-appointment { background: #e3f2fd; color: #1976d2; border-color: #bbdefb; }
    .type-prescription { background: #f3e5f5; color: #7b1fa2; border-color: #ce93d8; }
    .type-test_result { background: #e8f5e8; color: #388e3c; border-color: #a5d6a7; }
    .type-reminder { background: #fff3e0; color: #f57c00; border-color: #ffcc02; }
    .type-system { background: #f5f5f5; color: #616161; border-color: #bdbdbd; }
    .type-emergency { background: #ffebee; color: #d32f2f; border-color: #ef9a9a; }
    
    .unread-indicator {
        color: #007bff;
        font-size: 1rem;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .notification-time {
        font-size: 0.75rem;
        color: #6c757d;
    }
    
    .notification-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #212529;
    }
    
    .notification-message {
        color: #495057;
        margin-bottom: 1rem;
        line-height: 1.5;
    }
    
    .notification-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .mark-read-btn {
        font-size: 0.8rem;
        padding: 0.3rem 0.8rem;
    }
    
    .animate-slide-in {
        animation: slideIn 0.5s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .connection-status.connected {
        background-color: #28a745;
    }
    
    .connection-status.disconnected {
        background-color: #dc3545;
    }
    
    .empty-state {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-bell me-2"></i>Notifications
            </h2>
            <p class="text-muted mb-0">Manage your notification system and delivery status</p>
        </div>
        
        <!-- Admin Controls -->
        {% if is_admin %}
        <div class="quick-actions">
            <a href="{% url 'notifications:admin' %}" class="btn btn-quick" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                <i class="fas fa-cogs me-1"></i>Admin Panel
            </a>
            <button class="btn btn-quick" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white;" onclick="openTestModal()">
                <i class="fas fa-paper-plane me-1"></i>Send Test
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Statistics Overview (Admin Only) -->
    {% if is_admin %}
    <div class="stats-overview" id="statsOverview">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="fas fa-chart-line me-2"></i>System Overview
            </h5>
            <span class="admin-badge">ADMIN VIEW</span>
        </div>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-number" id="totalNotifications">-</div>
                <div class="stat-label">Total Notifications</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="pendingRetries">-</div>
                <div class="stat-label">Pending Retries</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="failedNotifications">-</div>
                <div class="stat-label">Failed Permanently</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="successRate">-</div>
                <div class="stat-label">Success Rate</div>
            </div>
        </div>
        <div class="text-center mt-3">
            <small class="opacity-75">Last updated: <span id="lastStatsUpdate">Loading...</span></small>
        </div>
    </div>
    {% endif %}

    <!-- Notifications Controls -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="d-flex align-items-center gap-3">
                <div class="d-flex align-items-center">
                    <span id="connection-status" class="badge bg-secondary">Disconnected</span>
                    <small class="ms-2 text-muted">WebSocket Status</small>
                </div>
                <div class="d-flex align-items-center">
                    <span id="unread-badge" class="badge bg-primary">{{ unread_count }}</span>
                    <small class="ms-2 text-muted">Unread</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <button id="refresh-btn" class="btn btn-outline-primary btn-sm me-2">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="markAllAsRead()">
                <i class="fas fa-check-double"></i> Mark All Read
            </button>
        </div>
    </div>

    <!-- Notification Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-3">
                    <form id="filter-form" class="row g-3 align-items-center">
                        <div class="col-auto">
                            <label class="form-label mb-0">Status:</label>
                        </div>
                        <div class="col-auto">
                            <select name="status" class="form-select form-select-sm">
                                <option value="all">All</option>
                                <option value="unread">Unread</option>
                                <option value="read">Read</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <label class="form-label mb-0">Type:</label>
                        </div>
                        <div class="col-auto">
                            <select name="type" class="form-select form-select-sm">
                                <option value="all">All Types</option>
                                <option value="appointment">Appointment</option>
                                <option value="prescription">Prescription</option>
                                <option value="test_result">Test Result</option>
                                <option value="reminder">Reminder</option>
                                <option value="system">System</option>
                                <option value="emergency">Emergency</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications List -->
    <div class="notifications-container">
        <div id="notifications-list">
            {% if notifications %}
                {% for notification in notifications %}
                <div class="notification-item {{ notification.readAt|yesno:'read,unread' }}" data-notification-id="{{ notification.id }}">
                    <div class="notification-content">
                        <div class="notification-header">
                            <div class="notification-type">
                                <span class="type-badge type-{{ notification.type }}">
                                    {% if notification.type == 'appointment' %}📅{% elif notification.type == 'prescription' %}💊{% elif notification.type == 'test_result' %}🔬{% elif notification.type == 'reminder' %}⏰{% elif notification.type == 'system' %}⚙️{% elif notification.type == 'emergency' %}🚨{% else %}📧{% endif %}
                                    {{ notification.type|capfirst }}
                                </span>
                                {% if not notification.readAt %}
                                <span class="unread-indicator">●</span>
                                {% endif %}
                            </div>
                            <div class="notification-time" title="{{ notification.createdAt|date:'Y-m-d H:i:s' }}">
                                {{ notification.createdAt|timesince }} ago
                            </div>
                        </div>
                        
                        <div class="notification-body">
                            <h4 class="notification-title">{{ notification.title }}</h4>
                            <p class="notification-message">{{ notification.message }}</p>
                            
                            {% if notification.metadata %}
                            <div class="notification-metadata">
                                <!-- Metadata display would go here -->
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="notification-actions">
                            {% if not notification.readAt %}
                            <button class="btn btn-sm btn-outline-primary mark-read-btn" data-notification-id="{{ notification.id }}">
                                Mark as Read
                            </button>
                            {% endif %}
                            
                            {% if notification.actionUrl %}
                            <a href="{{ notification.actionUrl }}" class="btn btn-sm btn-primary">
                                {{ notification.actionText|default:'View' }}
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="empty-state text-center py-5">
                <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No notifications yet</h4>
                <p class="text-muted">When you receive notifications, they will appear here.</p>
                {% if is_admin %}
                <button class="btn btn-primary" onclick="openTestModal()">
                    <i class="fas fa-paper-plane me-2"></i>Send Test Notification
                </button>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Load More Button -->
        {% if pagination.hasNextPage %}
        <div class="text-center mt-4">
            <button id="load-more-btn" class="btn btn-outline-primary">
                <i class="fas fa-chevron-down me-2"></i>Load More
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Test Notification Modal -->
{% if is_admin %}
<div class="modal fade" id="testNotificationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Test Notification</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="testNotificationForm">
                    <div class="mb-3">
                        <label for="testRecipient" class="form-label">Recipient Email</label>
                        <input type="email" class="form-control" id="testRecipient" required placeholder="admin@hospital.com">
                    </div>
                    <div class="mb-3">
                        <label for="testSubject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="testSubject" value="Test Notification from Hospital System">
                    </div>
                    <div class="mb-3">
                        <label for="testMessage" class="form-label">Message</label>
                        <textarea class="form-control" id="testMessage" rows="3">This is a test notification to verify the system is working correctly.</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Delivery Channels</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="testChannelEmail" checked>
                            <label class="form-check-label" for="testChannelEmail">Email</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="testChannelSms">
                            <label class="form-check-label" for="testChannelSms">SMS (if number provided)</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitTestNotification()">
                    <i class="fas fa-paper-plane me-2"></i>Send Test
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block base_websocket %}
<!-- Override base template WebSocket to prevent conflicts -->
{% endblock %}

{% block extra_js %}
<script src="{% static 'notifications/js/notification-client.js' %}"></script>
<script src="{% static 'notifications/js/notification-list.js' %}"></script>
<script>
// Load admin statistics if user is admin
{% if is_admin %}
let statsInterval;

function loadSystemStats() {
    fetch('{% url "notifications:retry_stats_api" %}')
        .then(response => response.json())
        .then(data => {
            if (data.statistics) {
                const stats = data.statistics;
                document.getElementById('totalNotifications').textContent = 
                    (stats.totalPending || 0) + (stats.totalProcessing || 0) + (stats.totalFailed || 0);
                document.getElementById('pendingRetries').textContent = stats.totalPending || 0;
                document.getElementById('failedNotifications').textContent = stats.totalFailed || 0;
                
                const total = (stats.totalPending || 0) + (stats.totalProcessing || 0) + (stats.totalFailed || 0);
                const successRate = total > 0 ? (((total - (stats.totalFailed || 0)) / total) * 100).toFixed(1) : '100.0';
                document.getElementById('successRate').textContent = successRate + '%';
                
                document.getElementById('lastStatsUpdate').textContent = new Date().toLocaleTimeString();
            }
        })
        .catch(error => {
            console.error('Error loading statistics:', error);
            document.getElementById('lastStatsUpdate').textContent = 'Failed to load';
        });
}

function startStatsRefresh() {
    loadSystemStats();
    statsInterval = setInterval(loadSystemStats, 60000); // Refresh every minute
}

function stopStatsRefresh() {
    if (statsInterval) {
        clearInterval(statsInterval);
    }
}

// Test notification functions
function openTestModal() {
    const modal = new bootstrap.Modal(document.getElementById('testNotificationModal'));
    modal.show();
}

function submitTestNotification() {
    const recipient = document.getElementById('testRecipient').value;
    const subject = document.getElementById('testSubject').value;
    const message = document.getElementById('testMessage').value;
    
    const channels = [];
    if (document.getElementById('testChannelEmail').checked) channels.push('email');
    if (document.getElementById('testChannelSms').checked) channels.push('sms');
    
    if (!recipient || channels.length === 0) {
        alert('Please provide a recipient and select at least one channel.');
        return;
    }
    
    // Create form and submit
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "notifications:send_test" %}';
    
    // Add CSRF token
    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrfmiddlewaretoken';
    csrfToken.value = '{{ csrf_token }}';
    form.appendChild(csrfToken);
    
    // Add form fields
    const fields = {
        'recipient': recipient,
        'subject': subject,
        'message': message
    };
    
    for (const [key, value] of Object.entries(fields)) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
    }
    
    // Add channels
    channels.forEach(channel => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'channels';
        input.value = channel;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    startStatsRefresh();
    
    // Handle page visibility changes
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopStatsRefresh();
        } else {
            startStatsRefresh();
        }
    });
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    stopStatsRefresh();
});

{% endif %}

// Function to mark all notifications as read
function markAllAsRead() {
    const unreadNotifications = document.querySelectorAll('.notification-item.unread');
    if (unreadNotifications.length === 0) {
        alert('No unread notifications to mark.');
        return;
    }
    
    if (!confirm(`Mark all ${unreadNotifications.length} unread notifications as read?`)) {
        return;
    }
    
    // Mark each notification as read
    unreadNotifications.forEach(notification => {
        const notificationId = notification.dataset.notificationId;
        if (notificationId) {
            // Find the mark as read button and click it
            const markReadBtn = notification.querySelector('.mark-read-btn');
            if (markReadBtn) {
                markReadBtn.click();
            }
        }
    });
}
</script>
{% endblock %}
